{{ if eq .chezmoi.os "windows" }}
# run_once_core_windows.ps1.tmpl
# Sets up core tools for Windows: PowerShell, Scoop, pipx, oh-my-posh, bat, etc.

# Self-elevate the script if required
if (-Not ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] 'Administrator')) {
  if ([int](Get-CimInstance -Class Win32_OperatingSystem | Select-Object -ExpandProperty BuildNumber) -ge 6000) {
    $CommandLine = "-NoExit -File `"" + $MyInvocation.MyCommand.Path + "`" " + $MyInvocation.UnboundArguments
    Start-Process -Wait -FilePath PowerShell.exe -Verb Runas -ArgumentList $CommandLine
    Exit
  }
}

Write-Output "--- Running Windows core setup script ---"

# Install or update PowerShell
$pwshInstallScript = "{{ .chezmoi.sourceDir }}\scripts\install-powershell.ps1"
if (Test-Path $pwshInstallScript) {
    Write-Output "Running PowerShell installation script..."
    & $pwshInstallScript
} else {
    Write-Warning "PowerShell install script not found at $pwshInstallScript"
}

# Install Scoop
if (-not (Get-Command scoop -ErrorAction SilentlyContinue)) {
    Write-Output "Installing Scoop..."
    Set-ExecutionPolicy RemoteSigned -scope CurrentUser -Force
    Invoke-RestMethod get.scoop.sh | Invoke-Expression
} else {
    Write-Output "Scoop is already installed."
}

# Ensure Scoop apps bucket is added
scoop bucket add extras
scoop update

# Install common CLI tools
$packages = @(
    "bat",
    "fd",
    "fzf",
    "git",
    "jq",
    "lsd",
    "oh-my-posh",
    "python",
    "vim",
    "curl",
    "ripgrep",
    "zoxide"
)

foreach ($pkg in $packages) {
    if (-not (scoop list | Select-String -Pattern "^$pkg")) {
        Write-Output "Installing $pkg..."
        scoop install $pkg
    } else {
        Write-Output "$pkg is already installed."
    }
}

# Install fonts
scoop bucket add nerd-fonts
scoop install JetBrainsMono-NF

# Install VSCode
if (-not (Get-Command code -ErrorAction SilentlyContinue)) {
    Write-Output "Installing Visual Studio Code..."
    scoop install vscode
} else {
    Write-Output "Visual Studio Code is already installed."
}

# Ensure VSCode CLI is on PATH
$codePath = "$env:USERPROFILE\\scoop\\apps\\vscode\\current\\bin"
if (-not ($env:PATH -split ';' | Where-Object { $_ -eq $codePath })) {
    [Environment]::SetEnvironmentVariable("PATH", "$env:PATH;$codePath", [EnvironmentVariableTarget]::User)
    Write-Output "Added VSCode CLI path to user PATH. You may need to restart your terminal."
} else {
    Write-Output "VSCode CLI path already in PATH."
}

# Install VSCode extensions
$vscodeExtensions = @(
    "cschlosser.doxdocgen",
    "eamodio.gitlens",
    "esbenp.prettier-vscode",
    "ms-azuretools.vscode-docker",
    "ms-python.python",
    "ms-toolsai.jupyter",
    "ms-vscode-remote.remote-containers",
    "ms-vscode.cmake-tools",
    "ms-vscode.cpptools-extension-pack",
    "ms-vscode.cpptools-themes",
    "ms-vscode.cpptools",
    "sashaweiss.block-travel",
    "streetsidesoftware.code-spell-checker",
    "twxs.cmake",
    "xaver.clang-format",
    "yzhang.markdown-all-in-one"
)

foreach ($ext in $vscodeExtensions) {
    if (-not (code --list-extensions | Select-String -Pattern $ext)) {
        code --install-extension $ext
        Write-Output "Installed VSCode extension: $ext"
    } else {
        Write-Output "VSCode extension $ext is already installed."
    }
}

# Ensure Python + pipx setup
if (-not (Get-Command pipx -ErrorAction SilentlyContinue)) {
    Write-Output "Installing pipx via Python..."
    python -m pip install --user pipx
    python -m pipx ensurepath
} else {
    Write-Output "pipx is already installed."
}

# pipx packages
$pipxPkgs = @(
    "black",
    "flake8",
    "mypy",
    "pre-commit",
    "poetry",
    "pip-tools",
    "mkdocs"
)

foreach ($pkg in $pipxPkgs) {
    if (-not (& pipx list | Select-String -Pattern $pkg)) {
        pipx install $pkg
    } else {
        Write-Output "$pkg already installed with pipx."
    }
}

# Final message
Write-Output "\n==== Windows core tools setup complete ===="
Write-Output "You may need to restart your terminal for all changes to take effect."
{{ end }}
